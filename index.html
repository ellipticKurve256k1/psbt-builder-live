<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bitcoin PSBT Builder</title>
  <style>
    :root {
      --bg: #0b1016;
      --bg-2: #121923;
      --panel: #161f2a;
      --panel-2: #1b2733;
      --line: #2b3948;
      --line-2: #3c4d5f;
      --text: #e6edf5;
      --muted: #9dafc4;
      --accent: #33b1ff;
      --accent-2: #1b95e0;
      --danger: #e36a76;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 1rem;
      font-family: "IBM Plex Sans", "Segoe UI", sans-serif;
      color: var(--text);
      background:
        radial-gradient(900px 500px at 0% 0%, #1a2d40 0%, transparent 55%),
        radial-gradient(900px 500px at 100% 0%, #102a3d 0%, transparent 50%),
        var(--bg);
    }

    h1,
    h2,
    h3,
    p {
      margin: 0;
    }

    label {
      display: block;
      margin-bottom: 0.35rem;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .app-shell {
      max-width: 1320px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 0.9rem;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      align-items: end;
      padding: 0.9rem 1rem;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(21, 30, 41, 0.9);
    }

    .menu-row {
      display: flex;
      gap: 0.55rem;
    }

    .menu-button {
      width: auto;
      margin: 0;
      padding: 0.5rem 0.9rem;
      border-color: #42586e;
      background: linear-gradient(180deg, #2d4154 0%, #253646 100%);
      color: #d1e2f3;
    }

    .menu-button.active {
      border-color: #2e9de1;
      background: linear-gradient(180deg, #1b7aba 0%, #125f92 100%);
      color: #eff8ff;
    }

    .title-wrap h1 {
      font-size: 1.7rem;
      letter-spacing: 0.01em;
    }

    .title-wrap p {
      margin-top: 0.25rem;
      color: var(--muted);
      font-size: 0.92rem;
    }

    .network-wrap {
      min-width: 220px;
      max-width: 280px;
      width: 100%;
    }

    input,
    select,
    textarea,
    button {
      width: 100%;
      margin-top: 0.42rem;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: var(--panel-2);
      color: var(--text);
      font-size: 0.95rem;
      padding: 0.6rem 0.72rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
    }

    input::placeholder,
    textarea::placeholder {
      color: #8194ab;
    }

    input:focus,
    select:focus,
    textarea:focus,
    button:focus-visible {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(51, 177, 255, 0.23);
    }

    input[type="checkbox"] {
      width: auto;
      margin: 0;
      accent-color: var(--accent);
    }

    textarea {
      resize: vertical;
      min-height: 130px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }

    button {
      cursor: pointer;
      font-weight: 600;
      border-color: var(--line-2);
      background: linear-gradient(180deg, #314353 0%, #273544 100%);
    }

    button:hover {
      border-color: #57718a;
      background: linear-gradient(180deg, #3a4f62 0%, #2d3e50 100%);
    }

    .workspace {
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) minmax(380px, 1fr);
      gap: 0.9rem;
      align-items: start;
    }

    .left-column,
    .right-column {
      display: flex;
      flex-direction: column;
      gap: 0.9rem;
      min-width: 0;
    }

    .card {
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(22, 31, 42, 0.9);
      padding: 0.95rem;
    }

    .card-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.7rem;
      margin-bottom: 0.7rem;
    }

    .card-head h2 {
      font-size: 1.07rem;
      font-weight: 620;
    }

    .head-action {
      width: auto;
      margin: 0;
      padding: 0.5rem 0.72rem;
      border-style: dashed;
      border-color: #4a627b;
      background: rgba(46, 67, 90, 0.35);
      color: #c8d9ec;
      white-space: nowrap;
    }

    .stack {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .row {
      display: flex;
      gap: 0.55rem;
      width: 100%;
      align-items: center;
      flex-wrap: nowrap;
    }

    .row input,
    .row button,
    .row select {
      width: auto;
      margin-top: 0;
    }

    .row .grow {
      flex: 1 1 280px;
      min-width: 0;
    }

    button.remove {
      width: 44px;
      min-width: 44px;
      flex: 0 0 44px;
      margin-top: 0;
      padding: 0.52rem 0;
      border-radius: 9px;
      line-height: 1;
      font-size: 1rem;
      border-color: #70444f;
      background: linear-gradient(180deg, #603a45 0%, #492c35 100%);
    }

    button.remove:hover {
      background: linear-gradient(180deg, #71444f 0%, #53323c 100%);
    }

    .script-label {
      margin-top: 0.22rem;
      color: var(--muted) !important;
      font-size: 0.84rem;
    }

    .action-row {
      margin-top: 0.2rem;
      display: flex;
      gap: 0.55rem;
    }

    .option-line {
      margin-top: 0.65rem;
      padding: 0.48rem 0.6rem;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: rgba(31, 43, 57, 0.62);
      display: flex;
      align-items: center;
      gap: 0.45rem;
    }

    .option-line label {
      margin: 0;
      color: #c6d6e8;
      cursor: pointer;
    }

    #opReturnGroup {
      margin-top: 0.62rem;
    }

    .hint {
      margin-top: 0.28rem;
      font-size: 0.82rem;
      color: var(--muted);
    }

    .input-warning {
      margin-top: 0.36rem;
      margin-bottom: 0.28rem;
      padding: 0.48rem 0.62rem;
      border-radius: 9px;
      border: 1px solid #8b3f48;
      background: rgba(227, 106, 118, 0.12);
      color: #ffd5da;
      font-weight: 600;
    }

    #opReturnByteStatus {
      margin-top: 0.38rem;
      font-size: 0.82rem;
      color: #9ec0df;
    }

    #opReturnByteStatus.error {
      color: var(--danger);
      font-weight: 600;
    }

    #opReturnMessage.error {
      border-color: var(--danger);
      box-shadow: 0 0 0 3px rgba(227, 106, 118, 0.18);
    }

    #createPsbt {
      flex: 1;
      margin: 0;
      border-color: #2493d8;
      background: linear-gradient(180deg, #1779ba 0%, #0e639d 100%);
    }

    #createPsbt:hover {
      background: linear-gradient(180deg, #1e8acf 0%, #116fb1 100%);
    }

    #createPsbt,
    #clearButton {
      min-height: 42px;
    }

    .hidden-config {
      display: none;
    }

    #clearButton,
    #copyPsbtButton,
    #downloadPsbtButton {
      width: auto;
      margin: 0;
      padding: 0.52rem 0.9rem;
    }

    #balanceTracker {
      background: rgba(20, 30, 40, 0.95);
    }

    .summary-title {
      margin-bottom: 0.55rem;
      font-size: 0.95rem;
      color: #dce9f6;
      font-weight: 700;
    }

    .summary-grid {
      display: flex;
      flex-direction: column;
      gap: 0.34rem;
      font-size: 0.92rem;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      gap: 0.9rem;
    }

    .summary-row strong {
      font-weight: 700;
    }

    .summary-row.total {
      margin-top: 0.16rem;
      padding-top: 0.38rem;
      border-top: 1px solid var(--line);
    }

    #availableBalance {
      color: var(--accent);
    }

    #feeCalc {
      min-height: 1.1rem;
      color: #c4d4e7;
      font-size: 0.9rem;
    }

    #psbtDisplay {
      margin-top: 0.9rem;
      background: rgba(18, 27, 37, 0.94);
    }

    #psbtBase64 {
      min-height: 260px;
      width: 100%;
      font-size: 0.9rem;
      line-height: 1.45;
    }

    .result-actions {
      margin-top: 0.55rem;
      display: flex;
      gap: 0.55rem;
      flex-wrap: wrap;
    }

    .app-page {
      display: block;
    }

    .app-page.hidden {
      display: none;
    }

    #rawTxHexInput {
      min-height: 170px;
    }

    #rawTxDecodedOutput {
      margin-top: 0.75rem;
      min-height: 170px;
      padding: 0.78rem;
      border: 1px solid #2f3f50;
      border-radius: 10px;
      background: #131a22;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 2rem;
      line-height: 1.38;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .tx-seg-0 { color: #e66868; }
    .tx-seg-1 { color: #5eb1ff; }
    .tx-seg-2 { color: #8fcd7a; }
    .tx-seg-3 { color: #ef9d5b; }
    .tx-seg-4 { color: #d986ff; }
    .tx-seg-5 { color: #74d9cf; }
    .tx-seg-6 { color: #f6cc67; }
    .tx-seg-7 { color: #f07b9a; }
    #rawTxDecodedOutput span { cursor: help; }

    #rawTxSummary {
      margin-top: 0.8rem;
      display: grid;
      gap: 0.7rem;
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .rawtx-summary-card {
      border: 1px solid #2f3f50;
      border-radius: 10px;
      background: #121923;
      padding: 0.7rem;
    }

    .rawtx-summary-title {
      margin: 0 0 0.45rem;
      font-size: 0.88rem;
      color: #9ec0df;
      letter-spacing: 0.02em;
    }

    .rawtx-summary-list {
      display: grid;
      gap: 0.45rem;
    }

    .rawtx-summary-item {
      border: 1px solid #2c3b4d;
      border-radius: 8px;
      background: #151f2b;
      padding: 0.5rem 0.58rem;
      display: grid;
      gap: 0.24rem;
    }

    .rawtx-summary-head {
      font-size: 0.8rem;
      color: #c4d4e7;
      font-weight: 600;
    }

    .rawtx-summary-row {
      display: grid;
      grid-template-columns: 82px 1fr;
      gap: 0.5rem;
      font-size: 0.78rem;
      line-height: 1.34;
      color: #c8d9ec;
    }

    .rawtx-summary-key {
      color: #87a6c4;
    }

    .rawtx-summary-value.mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      word-break: break-all;
    }

    #rawTxFetchStatus {
      min-height: 1.1rem;
      margin-top: 0.35rem;
      color: #9ec0df;
      font-size: 0.84rem;
    }

    #rawTxFetchStatus.error {
      color: var(--danger);
      font-weight: 600;
    }

    @media (max-width: 1050px) {
      .workspace {
        grid-template-columns: 1fr;
      }

      .network-wrap {
        max-width: none;
      }
    }

    @media (max-width: 760px) {
      body {
        padding: 0.8rem;
      }

      #rawTxSummary {
        grid-template-columns: 1fr;
      }

      .topbar {
        flex-direction: column;
        align-items: stretch;
      }

      .menu-row {
        flex-wrap: wrap;
      }

      .action-row,
      .result-actions {
        flex-direction: column;
      }

      #clearButton,
      #copyPsbtButton,
      #downloadPsbtButton {
        width: 100%;
      }

      .row {
        flex-wrap: wrap;
      }

      .row .grow {
        flex-basis: 100%;
      }
    }
  </style>
  <script type="module" crossorigin src="/assets/index-Doj__dSe.js"></script>
</head>
<body>
  <main class="app-shell">
    <header class="topbar">
      <div class="title-wrap">
        <h1>Bitcoin PSBT Builder</h1>
        <p>Build unsigned PSBTs with a side-by-side workflow.</p>
      </div>
      <div class="network-wrap">
        <label for="network">Network</label>
        <select id="network">
          <option value="mainnet">Mainnet</option>
          <option value="testnet">Testnet</option>
        </select>
      </div>
    </header>

    <nav class="menu-row">
      <button type="button" id="openBuilderPage" class="menu-button active">PSBT Builder</button>
      <button type="button" id="openDecoderPage" class="menu-button">Raw Transaction Hex Decoder</button>
    </nav>

    <section id="builderPage" class="app-page">
      <section class="workspace">
        <div class="left-column">
          <section class="card">
            <div class="card-head">
              <h2>Inputs (UTXOs)</h2>
              <button type="button" id="addInputButton" class="head-action">+ Add Input</button>
            </div>
            <div class="hint input-warning">Only P2WPKH as input is supported.</div>
            <div id="utxoContainer" class="stack"></div>
          </section>

          <section class="card">
            <div class="card-head">
              <h2>Outputs</h2>
              <button type="button" id="addOutputButton" class="head-action">+ Add Output</button>
            </div>
            <div id="outputContainer" class="stack"></div>
          </section>
        </div>

        <aside class="right-column">
          <section class="card">
            <div class="card-head">
              <h2>Build</h2>
            </div>

            <label for="importData">Import PSBT / Raw TX</label>
            <textarea
              id="importData"
              rows="5"
              placeholder="Paste PSBT base64, PSBT hex, or raw transaction hex"
            ></textarea>
            <button id="importDataButton" type="button" style="margin-top:0.55rem;">Load Into Form</button>
            <div class="hint">Auto-fills inputs, outputs, OP_RETURN, and sighash when data includes them.</div>

            <div class="action-row">
              <button id="createPsbt">Create PSBT</button>
              <button id="clearButton">Clear</button>
            </div>

            <div class="option-line">
              <input type="checkbox" id="includeOpReturn">
              <label for="includeOpReturn">Add OP_RETURN message</label>
            </div>

            <div id="opReturnGroup" style="display:none;">
              <label for="opReturnMessage">OP_RETURN Message (text or 0x hex)</label>
              <input type="text" id="opReturnMessage" placeholder="Enter text message">
              <div class="hint">Maximum 83 bytes. Hex format: 0x...</div>
              <div id="opReturnByteStatus">0 / 83 bytes</div>
            </div>

            <label for="sighashType" style="margin-top:0.9rem;">Sighash Type (all inputs)</label>
            <select id="sighashType">
              <option value="DEFAULT">Unset (wallet default)</option>
              <option value="ALL">SIGHASH_ALL</option>
              <option value="NONE">SIGHASH_NONE</option>
              <option value="SINGLE">SIGHASH_SINGLE</option>
              <option value="ALL_ANYONECANPAY">SIGHASH_ALL | ANYONECANPAY</option>
              <option value="NONE_ANYONECANPAY">SIGHASH_NONE | ANYONECANPAY</option>
              <option value="SINGLE_ANYONECANPAY">SIGHASH_SINGLE | ANYONECANPAY</option>
            </select>
            <div class="hint">Applies the same sighash type to every PSBT input.</div>

            <label for="txVersion" style="margin-top:0.9rem;">Transaction Version</label>
            <input type="text" id="txVersion" value="2" placeholder="2">
            <div class="hint">Decimal uint32. Imported version is restored here.</div>

            <label for="txLocktime" style="margin-top:0.9rem;">Transaction Locktime (hex)</label>
            <input type="text" id="txLocktime" value="00000000" placeholder="00000000">
            <div class="hint">8-hex uint32. Imported locktime is restored here.</div>

            <div class="hidden-config" aria-hidden="true">
              <input type="checkbox" id="includeChange" disabled>
              <div id="feeRateGroup"><input type="number" id="feeRate" step="any" min="0" inputmode="decimal"></div>
              <div id="changeAddrGroup"><input type="text" id="changeAddress"></div>
            </div>
          </section>

          <section id="balanceTracker" class="card">
            <div class="summary-title">Balance Summary</div>
            <div class="summary-grid">
              <div class="summary-row">
                <span>Total Inputs:</span>
                <strong id="totalInputs">0 BTC</strong>
              </div>
              <div class="summary-row">
                <span>Total Outputs:</span>
                <strong id="totalOutputs">0 BTC</strong>
              </div>
              <div class="summary-row total">
                <span>Fee:</span>
                <strong id="feeAmount">0 BTC</strong>
              </div>
              <strong id="availableBalance" style="display:none;">0 BTC</strong>
            </div>
          </section>

          <section class="card">
            <div id="feeCalc" style="display:none;"></div>
          </section>

        </aside>
      </section>
      <section id="psbtDisplay" class="card" style="display: none;">
        <label for="psbtBase64">PSBT (Base64) - Copy this to your wallet</label>
        <textarea id="psbtBase64" readonly rows="12"></textarea>
        <div class="result-actions">
          <button id="copyPsbtButton">Copy to Clipboard</button>
          <button id="downloadPsbtButton">Download PSBT File</button>
        </div>
      </section>
    </section>

    <section id="decoderPage" class="app-page hidden">
      <section class="card">
        <div class="card-head">
          <h2>Raw Transaction Hex Decoder</h2>
        </div>
        <label for="rawTxIdInput">TXID</label>
        <div class="row">
          <input
            id="rawTxIdInput"
            class="grow"
            type="text"
            placeholder="Enter txid (64 hex chars)"
          >
          <button type="button" id="fetchRawTxButton">Load Raw TX</button>
          <button type="button" id="clearRawTxButton">Clear</button>
        </div>
        <div class="hint">
          Mainnet: https://mempool.space/api/tx/{txid}, Testnet: https://mempool.space/testnet/api/tx/{txid}
        </div>
        <div id="rawTxFetchStatus" aria-live="polite"></div>
        <label for="rawTxHexInput">Raw Transaction Hex</label>
        <textarea
          id="rawTxHexInput"
          rows="6"
          placeholder="Paste raw transaction hex"
        ></textarea>
        <pre id="rawTxDecodedOutput" aria-live="polite"></pre>
        <div id="rawTxSummary" aria-live="polite">
          <section class="rawtx-summary-card">
            <h3 class="rawtx-summary-title">Inputs</h3>
            <div id="rawTxInputSummary" class="rawtx-summary-list"></div>
          </section>
          <section class="rawtx-summary-card">
            <h3 class="rawtx-summary-title">Outputs</h3>
            <div id="rawTxOutputSummary" class="rawtx-summary-list"></div>
          </section>
        </div>
      </section>
    </section>
  </main>
  <script>
    (function () {
      const maxBytes = 83;
      const includeOpReturn = document.getElementById("includeOpReturn");
      const opReturnMessage = document.getElementById("opReturnMessage");
      const byteStatus = document.getElementById("opReturnByteStatus");
      const createPsbtButton = document.getElementById("createPsbt");
      const utf8Encoder = new TextEncoder();

      function getByteState(value) {
        if (/^0x/i.test(value)) {
          const hexData = value.slice(2);
          if (!hexData) return { bytes: 0, error: "" };
          if (!/^[0-9a-fA-F]*$/.test(hexData)) return { bytes: 0, error: "Invalid hex data." };
          if (hexData.length % 2 !== 0) return { bytes: 0, error: "Hex length must be even." };
          return { bytes: hexData.length / 2, error: "" };
        }
        return { bytes: utf8Encoder.encode(value).length, error: "" };
      }

      function updateOpReturnState() {
        const isEnabled = includeOpReturn.checked;
        const value = opReturnMessage.value.trim();
        const state = getByteState(value);
        const tooLarge = state.bytes > maxBytes;
        const hasError = isEnabled && (tooLarge || !!state.error);

        if (!isEnabled) {
          byteStatus.textContent = "0 / 83 bytes";
          byteStatus.classList.remove("error");
          opReturnMessage.classList.remove("error");
          createPsbtButton.disabled = false;
          return;
        }

        if (state.error) {
          byteStatus.textContent = state.error + " (0 / 83 bytes)";
        } else if (tooLarge) {
          byteStatus.textContent = state.bytes + " / 83 bytes (exceeds limit)";
        } else {
          byteStatus.textContent = state.bytes + " / 83 bytes";
        }

        byteStatus.classList.toggle("error", hasError);
        opReturnMessage.classList.toggle("error", hasError);
        createPsbtButton.disabled = hasError;
      }

      includeOpReturn.addEventListener("change", updateOpReturnState);
      opReturnMessage.addEventListener("input", updateOpReturnState);
      document.getElementById("clearButton").addEventListener("click", function () {
        setTimeout(updateOpReturnState, 0);
      });
      updateOpReturnState();
    })();
  </script>
</body>
</html>
